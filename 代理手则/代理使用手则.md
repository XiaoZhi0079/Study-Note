# 代理使用手册

### 代理模式

全局：由代理软件接管的流量，全部发给代理节点。

规则：由代理软件接管的流量，按照规则，规则内的发给代理节点，规则之外则直连。

直连：所有流量不经过代理节点，但是经由代理软件内核（可以看日志，进行dns覆写等操作）。

tun（虚拟网卡）：理想状态下，代理软件接管本机所有流量，包括App，终端，命令行。

### DNS覆写

理想状态下，由代理软件接管本机所有的DNS请求。

以下是 **FakeIP** 和 **Redir-Host**（也常被称为 Real IP 模式）的详细对比和原理解析。

------

#### 1. FakeIP 模式（“假 IP”模式）

这是目前大多数 Clash 用户和配置文件的**首选推荐模式**。它的核心思想是：**“先上车，后补票”**。

##### 工作原理

当你的电脑（浏览器或 APP）试图访问 `www.google.com` 时：

1. **拦截请求：** 电脑向 DNS 服务器询问 `www.google.com` 的 IP。
2. **立即欺骗：** Clash 拦截这个请求，**根本不去查询真实的 IP**，而是立刻扔回一个假的局域网 IP（通常是 `198.18.x.x` 这种保留网段）。
3. **建立连接：** 电脑以为这是真的 IP，于是向这个假 IP 发送数据。
4. **反向映射：** Clash 收到发往假 IP 的数据包，查表知道这个假 IP 对应的是 `www.google.com`。
5. **远程解析：** 因为谷歌在clash的规则中，所以Clash 直接把域名 `www.google.com` 封装并通过代理协议发给远端的代理服务器（节点）。如若是百度这些直连的域名，clash则向配置的DNS服务器发起请求，拿到真实IP，再发起数据包。
6. **最终访问：** 由**远端的代理服务器**去解析真实的 IP 并访问目标网站。

##### 优点

- **速度极快：** 省去了本地 DNS 解析的等待时间（毫秒级响应）。
- **防止 DNS 污染：** 因为本地根本不解析真实 IP，所以运营商或防火墙无法通过 DNS 投毒来阻断你。
- **规则匹配更精准：** 分流规则主要基于域名匹配，FakeIP 模式天然保留了域名信息。

##### 缺点

- **IP 缓存污染：** 某些系统或软件可能会缓存这个假 IP。如果你关掉 Clash，这会儿再去访问同一个网站，电脑还在用假 IP 尝试连接，会导致断网（通常需要刷新 DNS 缓存）。

------

#### 2. Redir-Host 模式（“真 IP”模式）

这是传统的代理模式，核心思想是：**“老老实实查清楚再去”**。

##### 工作原理

当你的电脑试图访问 `www.google.com` 时：

1. **发起查询：** 电脑向 DNS 发起查询。
2. **真实解析：** Clash 接收请求，通过配置的 DNS 服务器（可能是远程 DNS 或加密 DNS）去查询该域名的**真实 IP**。
3. **返回真 IP：** Clash 拿到真实 IP 后，返回给电脑。
4. **规则判断：** Clash 拿到 IP 后，会根据 IP 分流规则（如 `IP-CIDR`）判断这个 IP 是该直连还是走代理。
5. **转发数据：** 如果走代理，再将数据转发出去。

##### 优点

- **兼容性好：** 此时电脑拿到的 IP 是真实的互联网 IP，对于那些对 IP 敏感的程序非常友好。
- **符合直觉：** 网络拓扑逻辑更符合标准 TCP/IP 流程。

##### 缺点

- **速度较慢：** 必须等待 DNS 解析完成才能发起连接。如果 DNS 服务器响应慢，打开网页就会有明显的“白屏”等待感。
- **容易受 DNS 污染：** 如果配置的 DNS 上游不干净（或者在解析过程中被劫持），解析到了错误的 IP，那么即使你有代理也可能无法访问。
- **DNS 泄露风险：** 可能会向本地 ISP 暴露你正在查询哪些域名。

------

#### 3. 核心区别总结表

| **特性**         | **FakeIP (推荐)**                                | **Redir-Host (传统)**                    |
| ---------------- | ------------------------------------------------ | ---------------------------------------- |
| **DNS 解析位置** | 远端代理服务器 (大部分情况)                      | 本地 / Clash 内置 DNS                    |
| **响应速度**     | **极快** (立即返回假 IP)                         | **较慢** (需等待解析)                    |
| **抗污染能力**   | 极强 (本地不解析真实 IP)                         | 较弱 (依赖 DNS 优选)                     |
| **系统兼容性**   | 一般 (可能影响极少数软件)                        | **极佳**                                 |
| **原理类比**     | 这里的路我不熟，我先带你上高速，到了出口再找路。 | 我先查好地图，确定详细坐标，然后再出发。 |

------

#### 4. 常见问题：Tun 模式下的配合

如果某个**游戏无法登录**、或者**局域网设备无法互联**，通常是因为 FakeIP 导致的。

*解决方法：* 在配置文件中将该游戏或局域网的域名/IP 加入 `fake-ip-filter`（过滤列表），让这些特定的地址强制走 Real IP 解析，其余的继续用 FakeIP。

#### 建议

如果主要用于日常网页浏览、看视频或编程开发：

> **建议直接使用规则模式+ FakeIP 模式。**

它能最大程度发挥代理网络的性能优势。如果遇到了特定的软件连不上网，再考虑将该软件加入白名单，或者（极少情况下）才切换回 Redir-Host。



